<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Livraison Rabat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  #map { height: 60vh; width: 100%; }
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  #controls { padding: 10px; }
  #scannerButton { margin-top: 5px; padding: 5px 10px; }
  #result { margin-top: 10px; font-weight: bold; }
</style>

<!-- Leaflet pour la carte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Turf.js pour détection de zone -->
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<!-- Tesseract.js pour OCR -->
<script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <input type="text" id="addressInput" placeholder="Tapez une adresse ici"/>
  <button id="geocodeButton">Vérifier le livreur</button>
  <button id="scannerButton">Scanner avec caméra</button>
  <div id="result"></div>
</div>

<script>
// Initialisation carte
var map = L.map('map').setView([34.0209, -6.8416], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Définition des polygones pour les zones
var zones = [
  {
    name: "Nasser",
    polygon: turf.polygon([[
      [-6.8511, 33.9972],
      [-6.8604, 34.0008],
      [-6.8517, 34.0115],
      [-6.8442, 34.0180],
      [-6.8418, 34.0215],
      [-6.8406, 34.0233],
      [-6.8424, 34.0265],
      [-6.8383, 34.0329],
      [-6.8350, 34.0327],
      [-6.8321, 34.0274],
      [-6.8217, 34.0245],
      [-6.8207, 34.0180],
      [-6.8197, 34.0137],
      [-6.8213, 34.0101],
      [-6.8342, 34.0003],
      [-6.8393, 33.9927],
      [-6.8456, 33.9921],
      [-6.8512, 33.9952],
      [-6.8512, 33.9972]
    ]])
  },
  {
    name: "Hassan",
    polygon: turf.polygon([[
      [-6.8131, 34.0050],
      [-6.8383, 33.9918],
      [-6.8392, 33.9850],
      [-6.8450, 33.9820],
      [-6.8361, 33.9704],
      [-6.8213, 33.9647],
      [-6.8056, 33.9804],
      [-6.7977, 33.9857],
      [-6.7967, 33.9888],
      [-6.8130, 34.0052]
    ]])
  },
  {
    name: "Othmane",
    polygon: turf.polygon([[
      [-6.8458, 34.0287],
      [-6.8426, 34.0244],
      [-6.8450, 34.0177],
      [-6.8527, 34.0112],
      [-6.8623, 33.9998],
      [-6.8523, 33.9969],
      [-6.8513, 33.9935],
      [-6.8441, 33.9904],
      [-6.8481, 33.9802],
      [-6.8614, 33.9683],
      [-6.8711, 33.9725],
      [-6.8872, 33.9676],
      [-6.9018, 33.9645],
      [-6.9073, 33.9699],
      [-6.8621, 34.0123],
      [-6.8460, 34.0288]
    ]])
  },
  {
    name: "Abderahim",
    polygon: turf.polygon([[
      [-6.8856, 33.9595],
      [-6.8815, 33.9683],
      [-6.8712, 33.9713],
      [-6.8614, 33.9676],
      [-6.8453, 33.9796],
      [-6.8341, 33.9679],
      [-6.8218, 33.9639],
      [-6.8106, 33.9448],
      [-6.8287, 33.9393],
      [-6.8680, 33.9410],
      [-6.8860, 33.9585]
    ]])
  }
];

// Afficher les zones sur la carte
zones.forEach(z => {
  var coords = z.polygon.geometry.coordinates[0].map(c => [c[1], c[0]]);
  L.polygon(coords, {color:'blue', fillOpacity:0.2}).addTo(map).bindPopup(z.name);
});

// Fonction pour trouver le livreur par coordonnées
function getLivreur(lat, lon) {
  var point = turf.point([lon, lat]);
  for (var i = 0; i < zones.length; i++) {
    if (turf.booleanPointInPolygon(point, zones[i].polygon)) {
      return zones[i].name;
    }
  }
  return null;
}

// Géocodage OpenStreetMap
async function geocode(address) {
  if (!address.toLowerCase().includes("rabat")) address += ", Rabat, Maroc";
  let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
  let res = await fetch(url);
  let data = await res.json();
  if (data.length > 0) return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
  else return null;
}

// Bouton géocodage manuel
document.getElementById('geocodeButton').addEventListener('click', async () => {
  let address = document.getElementById('addressInput').value;
  let coords = await geocode(address);
  if (!coords) {
    document.getElementById('result').innerText = "Adresse illisible ou hors zone";
    return;
  }
  let livreur = getLivreur(coords[0], coords[1]);
  document.getElementById('result').innerText = livreur ? "Livreur : " + livreur : "Adresse hors zone";
  if (livreur) map.setView(coords, 15);
});

// Scanner caméra avec Tesseract.js
document.getElementById('scannerButton').addEventListener('click', async () => {
  let video = document.createElement('video');
  video.setAttribute('autoplay', '');
  document.body.appendChild(video);
  try {
    let stream = await navigator.mediaDevices.getUserMedia({video: true});
    video.srcObject = stream;

    // Scanner toutes les 2 secondes
    let interval = setInterval(async () => {
      let canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      const { data: { text } } = await Tesseract.recognize(canvas, 'ara+eng');
      if (text.trim().length > 2) {
        clearInterval(interval);
        stream.getTracks().forEach(track => track.stop());
        video.remove();
        document.getElementById('addressInput').value = text.trim();
        document.getElementById('geocodeButton').click();
      }
    }, 2000);

  } catch (err) {
    alert("Impossible d’accéder à la caméra : " + err);
  }
});

</script>
</body>
</html>
